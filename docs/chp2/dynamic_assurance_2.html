<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dynamic Assurance (2/3) - High Assurance Rust: Developing Secure and Robust Software</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../landing.html">High Assurance Rust</a></li><li class="chapter-item expanded affix "><a href="../faq.html">Frequently Asked Questions (FAQ)</a></li><li class="chapter-item expanded affix "><a href="../engage.html">Engage with this Book!</a></li><li class="chapter-item expanded affix "><a href="../cfp.html">Sponsor Call for Proposals (CFP)</a></li><li class="chapter-item expanded affix "><a href="../download.html">Download</a></li><li class="chapter-item expanded affix "><a href="../changelog.html">Changelog</a></li><li class="chapter-item expanded affix "><a href="../license.html">License</a></li><li class="chapter-item expanded affix "><li class="part-title">Novice: Systems Security</li><li class="spacer"></li><li class="chapter-item expanded "><a href="../chp1/_index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chp1/why_this_book.html"><strong aria-hidden="true">1.1.</strong> Why this book?</a></li><li class="chapter-item expanded "><a href="../chp1/how_is_this_book_structured.html"><strong aria-hidden="true">1.2.</strong> How is this book structured?</a></li><li class="chapter-item expanded "><a href="../chp1/challenges.html"><strong aria-hidden="true">1.3.</strong> Hands-on Learning</a></li><li class="chapter-item expanded "><a href="../chp1/about_the_team.html"><strong aria-hidden="true">1.4.</strong> About the Team</a></li><li class="chapter-item expanded "><a href="../chp1/_hands_on.html"><strong aria-hidden="true">1.5.</strong> Warmup: Environment Setup</a></li></ol></li><li class="chapter-item expanded "><a href="../chp2/_index.html"><strong aria-hidden="true">2.</strong> Software Assurance</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chp2/static_vs_dynamic.html"><strong aria-hidden="true">2.1.</strong> Static vs. Dynamic Tools</a></li><li class="chapter-item expanded "><a href="../chp2/static_assurance_1.html"><strong aria-hidden="true">2.2.</strong> Static Assurance (1/2)</a></li><li class="chapter-item expanded "><a href="../chp2/static_assurance_2.html"><strong aria-hidden="true">2.3.</strong> Static Assurance (2/2)</a></li><li class="chapter-item expanded "><a href="../chp2/dynamic_assurance_1.html"><strong aria-hidden="true">2.4.</strong> Dynamic Assurance (1/3)</a></li><li class="chapter-item expanded "><a href="../chp2/dynamic_assurance_2.html" class="active"><strong aria-hidden="true">2.5.</strong> Dynamic Assurance (2/3)</a></li><li class="chapter-item expanded "><a href="../chp2/dynamic_assurance_3.html"><strong aria-hidden="true">2.6.</strong> Dynamic Assurance (3/3)</a></li><li class="chapter-item expanded "><a href="../chp2/limits.html"><strong aria-hidden="true">2.7.</strong> Limitations and Threat Modeling</a></li><li class="chapter-item expanded "><a href="../chp2/cli.html"><strong aria-hidden="true">2.8.</strong> DIY CLI Encryption Tool</a></li><li class="chapter-item expanded "><a href="../chp2/operational_assurance_1.html"><strong aria-hidden="true">2.9.</strong> Operational Assurance (1/2)</a></li><li class="chapter-item expanded "><a href="../chp2/operational_assurance_2.html"><strong aria-hidden="true">2.10.</strong> Operational Assurance (2/2)</a></li><li class="chapter-item expanded "><a href="../chp2/_hands_on.html"><strong aria-hidden="true">2.11.</strong> Challenge: Extend the CLI Tool</a></li></ol></li><li class="chapter-item expanded "><a href="../chp3/_index.html"><strong aria-hidden="true">3.</strong> Rust Zero-Crash Course</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chp3/undef.html"><strong aria-hidden="true">3.1.</strong> On Undefined Behavior</a></li><li class="chapter-item expanded "><a href="../chp3/rust_1_low_data_rep.html"><strong aria-hidden="true">3.2.</strong> Rust: Low-Level Data (1/6)</a></li><li class="chapter-item expanded "><a href="../chp3/rust_2_high_data_rep.html"><strong aria-hidden="true">3.3.</strong> Rust: High-Level Data (2/6)</a></li><li class="chapter-item expanded "><a href="../chp3/rust_3_ctrl_flow.html"><strong aria-hidden="true">3.4.</strong> Rust: Control Flow (3/6)</a></li><li class="chapter-item expanded "><a href="../chp3/rust_4_own_1.html"><strong aria-hidden="true">3.5.</strong> Rust: Ownership Principles (4/6)</a></li><li class="chapter-item expanded "><a href="../chp3/rust_5_own_2.html"><strong aria-hidden="true">3.6.</strong> Rust: Ownership in Practice (5/6)</a></li><li class="chapter-item expanded "><a href="../chp3/rust_6_error.html"><strong aria-hidden="true">3.7.</strong> Rust: Error Handling (6/6)</a></li><li class="chapter-item expanded "><a href="../chp3/modules.html"><strong aria-hidden="true">3.8.</strong> The Module System</a></li><li class="chapter-item expanded "><a href="../chp3/tooling.html"><strong aria-hidden="true">3.9.</strong> Recommended Tooling</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.10.</strong> Rust's Release Cycle</div></li><li class="chapter-item expanded "><a href="../chp3/_hands_on.html"><strong aria-hidden="true">3.11.</strong> Challenge: Port a Program</a></li></ol></li><li class="chapter-item expanded "><a href="../chp4/_index.html"><strong aria-hidden="true">4.</strong> Understanding Memory</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> A Software Perspective</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> An Attacker's Perspective</div></li><li class="chapter-item expanded "><a href="../chp4/safe_rust_PLACEHOLDER.html"><strong aria-hidden="true">4.3.</strong> Rust's Memory Safety Guarantees</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.4.</strong> Integer Representation Issues</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.5.</strong> The #![no_std] Attribute</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.6.</strong> Case Study: Real-world Rust CVEs</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.7.</strong> Debugging with Mozilla rr</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.8.</strong> Writing an Exploit</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.9.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><li class="part-title">Advanced Beginner: Core Project</li><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Binary Search Tree (BST) Basics</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Core BST Operations in Python</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.</strong> Problems Translating to Rust</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.3.</strong> The Importance of Balance</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.4.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.5.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Building an Arena Allocator</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Let's Talk Allocators</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> A Stack-Only Arena</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Index-based Data Structures</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.4.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.5.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> A Self-balancing BST</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chp7/traits.html"><strong aria-hidden="true">7.1.</strong> Interface-relevant Traits</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.2.</strong> Scapegoat Trees</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.3.</strong> Insert</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.4.</strong> Remove</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.5.</strong> Find</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.6.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Digital Twin Testing</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">8.1.</strong> Basic QEMU Internals</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.2.</strong> How Semi-hosting Works</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.</strong> CLI REPL Harness</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.4.</strong> Limitations</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.5.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.6.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Building Maps and Sets</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">9.1.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.2.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> Implementing Iterators</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">10.1.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.2.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><li class="part-title">Competent: Validation and Deployment</li><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> Static Verification</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">11.1.</strong> An Introduction to 1st Order Logic</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.2.</strong> Proving Absence of Panics</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.3.</strong> Deductively Verifying our Arena Allocator</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.4.</strong> Model Checking for unsafe Code</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.5.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.6.</strong> Challenge: Prove a Sorting Algorithm</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> Dynamic Testing</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">12.1.</strong> Introduction to Coverage-Guided Fuzzing</div></li><li class="chapter-item expanded "><a href="../chp12/diff_fuzz_PLACEHOLDER.html"><strong aria-hidden="true">12.2.</strong> Building a Differential Fuzzing Harness</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.3.</strong> Using Miri to Detect Undefined Behavior</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.4.</strong> Benchmarking and Optimization</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.5.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.6.</strong> Challenge: Bug-hunting with Fuzzers</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> Operational Deployment</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">13.1.</strong> Understanding unsafe (1/3)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.2.</strong> Understanding unsafe (2/3)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.3.</strong> Understanding unsafe (3/3)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.4.</strong> CFFI 101</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.5.</strong> C99 Interoperability</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.6.</strong> Python3 Interoperability</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.7.</strong> Runtime Balance Reconfiguration</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.8.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.9.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> Maximizing Assurance</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">14.1.</strong> Rust Security Research</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.2.</strong> Rust's Limitations</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.3.</strong> Best Practices Beyond Rust</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.4.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.5.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><li class="part-title">Conclusion</li><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.</strong> Review</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">15.1.</strong> Key Concepts</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.2.</strong> Key Blue-Team Skills</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.3.</strong> Key Red-Team Skills</div></li></ol></li><li class="chapter-item expanded "><a href="../chp16_appendix/_index.html"><strong aria-hidden="true">16.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">16.1.</strong> Setup: Using our Docker Container</div></li><li class="chapter-item expanded "><a href="../chp16_appendix/tools.html"><strong aria-hidden="true">16.2.</strong> Inventory: Tools of the Trade</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/books.html"><strong aria-hidden="true">16.3.</strong> Inventory: Recommended Reading</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/resources.html"><strong aria-hidden="true">16.4.</strong> Inventory: Additional Resources</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/crypto.html"><strong aria-hidden="true">16.5.</strong> Fundamentals: Stream Ciphers</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/types.html"><strong aria-hidden="true">16.6.</strong> Fundamentals: Type Systems</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/components.html"><strong aria-hidden="true">16.7.</strong> Fundamentals: Component-Based Design</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/mem_hierarch.html"><strong aria-hidden="true">16.8.</strong> Fundamentals: Memory Hierarchy</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.9.</strong> Fundamentals: Dynamic Linking</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.10.</strong> Misc: Size Optimization</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.11.</strong> Misc: The Typestate Pattern</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.12.</strong> Misc: C++ Interoperability</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.13.</strong> Misc: Compile-time Metaprogramming</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">High Assurance Rust: Developing Secure and Robust Software</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/tnballo/high-assurance-rust" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://highassurance.rs/engage.html#submit-feedback-questions-issues-or-prs" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dynamic-assurance-2-of-3"><a class="header" href="#dynamic-assurance-2-of-3">Dynamic Assurance (2 of 3)</a></h1>
<p>Like any stream cipher, RC4 needs to generate a <em>keystream</em> and bitwise XOR it with <em>plaintext</em> to create <em>ciphertext</em>. That's how encryption works.</p>
<ul>
<li>
<p><em>Keystream</em> - data that is reproducible but indistinguishable from random.</p>
</li>
<li>
<p><em>Plaintext</em> - unencrypted data.</p>
</li>
<li>
<p><em>Ciphertext</em> - encrypted data.</p>
</li>
</ul>
<p>Keystream generation is implemented using a buffer to represent <em>cipher state</em>.
Mechanically, RC4's cipher state is a 256 byte array, named <code>s</code>, and indexed with two variables, <code>i</code> and <code>j</code>.
Our first step is creating a structure to store this ever-changing state and the current values of its indexes.
We'll want to add the following at the top of <code>crypto_tool/rc4/lib.rs</code>:</p>
<pre><code class="language-rust ignore">#![cfg_attr(not(test), no_std)]
#![forbid(unsafe_code)]

#[derive(Debug)]
pub struct Rc4 {
    s: [u8; 256],
    i: u8,
    j: u8,
}
</code></pre>
<ul>
<li>
<p>The first 2 lines are <em>attributes</em>: they communicate with the compiler to configure our project.</p>
</li>
<li>
<p><code>#![cfg_attr(not(test), no_std)]</code> is a conditional attribute. It applies to the whole crate and informs the compiler that, unless doing a <code>test</code> build, our library makes no assumptions about the system it's going to run on.</p>
<ul>
<li><code>no_std</code> roughly translates to &quot;don't depend on a standard library or runtime support being available&quot;. Although this restricts us to a set of core Rust features, it makes our code portable for embedded use cases: firmware, bootloaders, kernels, etc. We'll discuss <code>#![no_std]</code> more thoroughly in Chapter 4.</li>
</ul>
</li>
<li>
<p><code>#![forbid(unsafe_code)]</code> is an unconditional attribute. It again applies to the entire crate, telling the compiler to <em>ensure</em> the library has no <code>unsafe</code> code blocks. This allows our code to maximize Rust's memory safety guarantees, even if we refactor it or add new features later.</p>
<ul>
<li>We'll discuss <code>unsafe</code> throughout the book, but won't use this keyword in our main project.</li>
</ul>
</li>
<li>
<p><code>#[derive(Debug)]</code> is a <em>derive macro</em> for something called a <em>trait</em> (definition of shared behavior, explained in Chapter 3). Macros generate additional code. Writing macros is an advanced topic, but you can leverage existing macros even as a beginner<sup class="footnote-reference"><a href="#BeginMacro">1</a></sup>.</p>
<ul>
<li>Notice how <code>#[derive(Debug)]</code> sits atop the <code>Rc4</code> structure? It only applies to this structure, telling the compiler how to pretty print its contents to a console<sup class="footnote-reference"><a href="#TraitDebug">2</a></sup>. Using this macro makes our stream cipher convenient to visually debug in test builds.</li>
</ul>
</li>
<li>
<p>The <code>Rc4</code> structure is the most important part of the above code. Though not an <em>object</em> in the traditional sense<sup class="footnote-reference"><a href="#Obj">3</a></sup>, our structure encapsulates private data and we're going to define methods that operate on that data next. <code>Rc4</code>'s three fields are:</p>
<ul>
<li>
<p><code>s</code>: cipher state, an array of 256 bytes (unsigned, 8-bit integers - hence <code>u8</code>).</p>
</li>
<li>
<p><code>i</code>: &quot;incrementing&quot; index for key stream generation.</p>
</li>
<li>
<p><code>j</code>: &quot;jumping&quot; index for key stream generation.</p>
</li>
</ul>
</li>
</ul>
<p>We're now ready to implement the two halves of RC4's logic: KSA and PRGA.</p>
<blockquote>
<p><strong>WARNING! RC4 is insecure.</strong></p>
<p>Real-world projects need to select a well-audited implementation of a modern, well-tested cipher.
Remember, we've chosen RC4 for this chapter's example because it's relatively easy to implement.
RC4 isn't suitable for professional projects.</p>
</blockquote>
<h2 id="1-the-key-scheduling-algorithm-ksa"><a class="header" href="#1-the-key-scheduling-algorithm-ksa">1. The Key-Scheduling Algorithm (KSA)</a></h2>
<p>The goal of RC4's KSA step is initializing the cipher state array by computing a <em>permutation</em> influenced by a variable-length (40 to 2,048 bit) secret key.</p>
<p>It's best to put this logic in <code>Rc4</code>'s constructor.
So that a library user doesn't have to remember to call a special initialization function before encrypting data.
The cipher instance returned by the constructor will already be initialized.</p>
<blockquote>
<p><strong>Function-related Terminology</strong></p>
<p>This section will use two technical terms.
The concepts aren't unique to Rust, but the terms have specific meaning in Rust programs:<sup class="footnote-reference"><a href="#AssocMeth">4</a></sup></p>
<ul>
<li>
<p><strong>Associated function:</strong> A function that is defined on a structure, but <em>does not</em> take <code>&amp;self</code> (reference to instance of structure) as its first parameter. It doesn't read or write structure fields.</p>
</li>
<li>
<p><strong>Method:</strong> A function defined on a structure that <em>does</em> take <code>&amp;self</code> or <code>&amp;mut self</code> as the first parameter. It reads and/or writes fields on a specific instance of a structure.</p>
</li>
</ul>
</blockquote>
<p>By convention, Rust constructors are <em>associated functions</em> (no <code>self</code> parameter) named <code>new</code> that return an instance of the structure being constructed.</p>
<p>Let's add one that performs KSA, right below the <code>Rc4</code> structure definition.
Notice we define <code>new</code> inside an <code>impl Rc4</code> block, tying it to the structure of the same name:</p>
<pre><code class="language-rust ignore">impl Rc4 {
    /// Init a new Rc4 stream cipher instance
    pub fn new(key: &amp;[u8]) -&gt; Self {
        // Verify valid key length (40 to 2048 bits)
        assert!(5 &lt;= key.len() &amp;&amp; key.len() &lt;= 256);

        // Zero-init our struct
        let mut rc4 = Rc4 {
            s: [0; 256],
            i: 0,
            j: 0,
        };

        // Cipher state identity permutation
        for (i, b) in rc4.s.iter_mut().enumerate() {
            // s[i] = i
            *b = i as u8;
        }

        // Process for 256 iterations, get starting cipher state permutation
        let mut j: u8 = 0;
        for i in 0..256 {
            // j = (j + s[i] + key[i % key_len]) % 256
            j = j.wrapping_add(rc4.s[i]).wrapping_add(key[i % key.len()]);

            // Swap values of s[i] and s[j]
            rc4.s.swap(i, j as usize);
        }

        // Return our initialized Rc4
        rc4
    }
}
</code></pre>
<p>The above code might make you a little uncomfortable.
That's OK.
Learning any new language involves squinting at code you don't fully understand.
And that's usually not a great feeling.</p>
<p>To make matters worse, cryptographic code is just its own weird thing - regardless of the implementation language.
Let's double down and try to make sense of it:</p>
<ul>
<li>
<p><code>new</code> takes a single parameter, <code>key</code>, which is a <em>reference to a slice of bytes</em>. This signature makes passing in key data efficient<sup class="footnote-reference"><a href="#SliceEff">5</a></sup> and flexible<sup class="footnote-reference"><a href="#SliceFlex">6</a></sup>. We'll cover slices in Chapter 3.</p>
</li>
<li>
<p>The <code>assert!</code> statement, another macro, ensures the user of our API provides a key of valid length. If not, our program will terminate at this line. That's an aggressive way to handle errors. We'll talk about other options later.</p>
</li>
<li>
<p><code>let mut rc4 = ...</code> creates a <em>mutable</em> instance of our <code>Rc4</code> structure with all fields zero initialized. Variables are immutable by default in Rust. But we'll be setting up cipher state (the <code>s</code> array), we need the <code>mut</code> keyword here.</p>
</li>
<li>
<p>The next bit of code, a <code>for</code> loop identity permutation<sup class="footnote-reference"><a href="#IDPerm">7</a></sup>, is just a fancy way to set <code>s[0] = 0, s[1] = 1, s[2] = 2, ..., s[255] = 255</code>. It uses <em>iterators</em>. We'll implement our own iterators in Chapter 10, so let's not dwell on the syntax right now.</p>
</li>
<li>
<p>The subsequent <code>for</code> loop <em>further permutes</em> the cipher state <code>s</code>. Three details worth pointing out:</p>
<ul>
<li>
<p>We have to use the <code>wrapping_add</code> function instead of the addition operator (<code>+</code>) in cryptographic code because we want <em>integer overflow</em> (explanation coming in Chapter 3) to emulate modular arithmetic<sup class="footnote-reference"><a href="#ModArith">8</a></sup>.</p>
</li>
<li>
<p>Have you ever swapped two variables using a third (probably named <code>temp</code>)? If your answer is &quot;good God, a hundred times&quot; then you'll appreciate how <code>swap</code> is a built-in method for arrays in Rust.</p>
</li>
<li>
<p>Indexes are always register-width unsigned integers in Rust. So, in the call to <code>swap</code>, we promote <code>j</code> (a lowly <code>u8</code>) to a <code>usize</code> with the <code>as</code> keyword. Think of this minor detail as a &quot;safe cast&quot;<sup class="footnote-reference"><a href="#Cast">9</a></sup>.</p>
</li>
</ul>
</li>
<li>
<p>The final line of the <code>new</code> function returns an initialized instance of an <code>Rc4</code> structure. Rust functions don't need the <code>return</code> keyword unless you want to return early (e.g. halfway through the function body) for some reason.</p>
<ul>
<li>The return type of the function (specified right after <code>-&gt;</code>) is <code>Self</code>. Because <code>new</code> is inside an <code>impl Rc4</code> block, this is shorthand for returning an instance of an <code>Rc4</code> structure.</li>
</ul>
</li>
</ul>
<p>Visualizing a round of permutation might make the concept more tangible.
Every loop iteration, <code>i</code> and <code>j</code> change (with <code>j</code> being influenced by the key) and <code>rc4.s.swap(i, j as usize)</code> just switches two values within <code>s</code>:</p>
<br>
<p align="center">
  <img width="100%" src="rc4_1.svg">
  <figure>
  <br>
  <figcaption><center>Visualization of swapping <i><b>s[i]</i></b> and <i><b>s[j]</i></b></center></figcaption><br>
  </figure>
</p>
<h2 id="2-pseudo-random-generation-algorithm-prga"><a class="header" href="#2-pseudo-random-generation-algorithm-prga">2. Pseudo-Random Generation Algorithm (PRGA)</a></h2>
<p>The <code>new</code> function creates and initializes an instance of the <code>Rc4</code> cipher.
We need another function that uses an <code>Rc4</code> instance to generate a keystream.
Once we have a keystream, we can encrypt data with it.</p>
<p><code>prga_next</code> is our keystream generation function, it outputs a single keystream byte each time it's called.
We'll add it right after the <code>new</code> function, inside the same <code>impl Rc4</code> block.</p>
<p>Unlike the <code>new</code> <em>associated function</em>, <code>prga_next</code> is a <em>method</em>.
Methods always take a reference to <code>self</code>, an instance of the structure they're being called on, as their first parameter.</p>
<pre><code class="language-rust ignore">impl Rc4 {
    // ..new() definition omitted..

    /// Output the next byte of the keystream
    pub fn prga_next(&amp;mut self) -&gt; u8 {
        // i = (i + 1) mod 256
        self.i = self.i.wrapping_add(1);

        // j = (j + s[i]) mod 256
        self.j = self.j.wrapping_add(self.s[self.i as usize]);

        // Swap values of s[i] and s[j]
        self.s.swap(self.i as usize, self.j as usize);

        // k = s[(s[i] + s[j]) mod 256]
        let k = self.s[(self.s[self.i as usize].wrapping_add(self.s[self.j as usize])) as usize];

        // output K
        k
    }
}
</code></pre>
<p>This function performs similar operations to the <code>new</code> function, so we don't need to go over it in detail.
We're concerned with getting a taste of Rust, not with the specific operations RC4's design dictates.
There is, however, one detail worth pointing out:</p>
<ul>
<li><code>prga_next</code>'s sole parameter is <code>&amp;mut self</code>, a <em>mutable reference</em> to the <code>Rc4</code> structure on which it will be called. We need the <code>mut</code> keyword here again because this function makes changes to an <code>Rc4</code> struct - it writes indexes <code>i</code> and <code>j</code>, and swaps bytes inside the cipher state buffer <code>s</code>.</li>
</ul>
<p>As an aside - we can visualize that second-to-last line, <code>let k = ...</code>, like so:<sup class="footnote-reference"><a href="#RC4Wiki">10</a></sup></p>
<br>
<p align="center">
  <img width="100%" src="rc4_2.svg">
  <figure>
  <br>
  <figcaption><center>Visualization of <i><b>k = s[(s[i] + s[j]) mod 256]</i></b></center></figcaption><br>
  </figure>
</p>
<h2 id="3-endecryption"><a class="header" href="#3-endecryption">3. {En,De}cryption</a></h2>
<h3 id="the-classic-flexible-interface"><a class="header" href="#the-classic-flexible-interface">The Classic Flexible Interface</a></h3>
<p>We implement encryption by XORing each <code>prga_next</code> output byte (keystream) with each byte of the plaintext.
Since XOR is reversible, the same function also works for decryption!</p>
<pre><code class="language-rust ignore">impl Rc4 {
    // ..new() definition omitted..

    /// Stateful, in-place en/decryption (current keystream XORed with data).
    /// Use if plaintext/ciphertext is transmitted in chunks.
    pub fn apply_keystream(&amp;mut self, data: &amp;mut [u8]) {
        for b_ptr in data {
            *b_ptr ^= self.prga_next();
        }
    }

    // ..prga_next() definition omitted..
}
</code></pre>
<p>Implementing encryption within a <em>method</em> maximizes flexibility: if we receive data in [potentially variable length] chunks, a single instance of <code>Rc4</code> can perform &quot;running&quot; encryption across multiple chunks like so (the below is an API usage example, not part of our <code>Rc4</code> implementation):</p>
<pre><code class="language-rust ignore">let key = [0x1, 0x2, 0x3, 0x4, 0x5];

let msg_1 = [0x48, 0x65, 0x6c, 0x6c, 0x6f]; // &quot;Hello&quot;
let msg_2 = [0x20, 0x57, 0x6f, 0x72, 0x6c, 0x64, 0x21]; // &quot; World!&quot;

// Encrypt in-place
let mut rc4 = Rc4::new(&amp;key);
rc4.apply_keystream(&amp;mut msg_1);
rc4.apply_keystream(&amp;mut msg_2);

// Decrypt in-place
let mut rc4 = Rc4::new(&amp;key);
rc4.apply_keystream(&amp;mut msg_1);
rc4.apply_keystream(&amp;mut msg_2);
</code></pre>
<p>Most real-world stream cipher libraries use an API like this one.
But it entails subtle complexity: <code>rc4</code> is stateful and must be re-constructed prior to decryption with <code>new</code>.
Moreover, the order of parameters to <code>apply_keystream</code> matters - decryption would produce the incorrect result if we accidentally called <code>rc4.apply_keystream(&amp;mut msg_2)</code> before <code>rc4.apply_keystream(&amp;mut msg_1)</code> in the above.</p>
<h3 id="making-the-common-case-easier"><a class="header" href="#making-the-common-case-easier">Making the Common Case Easier</a></h3>
<p>Implementing encryption within an <em>associated function</em> provides a simpler interface, so long as all the data is in memory at once.
Which might be the case reasonably often.
Notice it's really just a wrapper that hides state from the caller:</p>
<pre><code class="language-rust ignore">impl Rc4 {
    // ..new() definition omitted..

    // ..apply_keystream() definition omitted..

    /// Stateless, in-place en/decryption (keystream XORed with data).
    /// Use if entire plaintext/ciphertext is in-memory at once.
    pub fn apply_keystream_static(key: &amp;[u8], data: &amp;mut [u8]) {
        let mut rc4 = Rc4::new(key);
        rc4.apply_keystream(data);
    }

    // ..prga_next() definition omitted..
}
</code></pre>
<p>Now we can en/decrypt with a single method call, no need to worry about the state of an <code>Rc4</code> instance (API usage example below):</p>
<pre><code class="language-rust ignore">let key = [0x1, 0x2, 0x3, 0x4, 0x5];

let msg = [
    0x48, 0x65, 0x6c, 0x6c, 0x6f, 0x20, 0x57, 0x6f,
    0x72, 0x6c, 0x64, 0x21,
]; // &quot;Hello World!&quot;

// Encrypt in-place
Rc4::apply_keystream_static(&amp;key, &amp;mut msg);

// Decrypt in-place
Rc4::apply_keystream_static(&amp;key, &amp;mut msg);
</code></pre>
<p>With our two en/decryption functions done, we've now finished implementation.
Time for validation.
Cryptography software really needs to be correct, we can't stop here.
Let's put this code through its paces!</p>
<blockquote>
<p><strong>How can encryption and decryption be the same operation?</strong></p>
<p>In short, because XOR is both reversible and, due to the nature of the keystream, unpredictable:</p>
<ul>
<li>
<p>First, <code>cipher_text = plain_text ^ key_stream</code> (encryption).</p>
</li>
<li>
<p>Then, <code>plain_text = cipher_text ^ key_stream</code> (decryption).</p>
</li>
<li>
<p>The key stream can flip any bit in the plaintext as if by 50/50 random chance.</p>
</li>
</ul>
<p>For a more mathematically principled treatment, we recommend the proof on page 32 of Paar and Pelzl's <em>Understanding Cryptography</em><sup class="footnote-reference"><a href="#UnderstandingCrypto">11</a></sup>.
While it's a university textbook, the formalisms are lightweight and precise.
It's an excellent introduction to the field of cryptography.
And the book is supplemented by free video lectures<sup class="footnote-reference"><a href="#UnderstandingCryptoVideo">12</a></sup>.</p>
</blockquote>
<hr />
<div class="footnote-definition" id="BeginMacro"><sup class="footnote-definition-label">1</sup>
<p>Unlike C macros, Rust macros are <em>hygienic</em>: they won't cause subtle problems by capturing identifiers. This is part of what makes them so easy to use. In fact, <code>println!</code> is a macro. So you already used a macro when running the &quot;Hello world!&quot; program at the end of Chapter 1.</p>
</div>
<div class="footnote-definition" id="TraitDebug"><sup class="footnote-definition-label">2</sup>
<p><a href="https://doc.rust-lang.org/std/fmt/trait.Debug.html"><em>Trait <code>std::fmt::Debug</code></em></a>. The Rust Team (Accessed 2022).</p>
</div>
<div class="footnote-definition" id="Obj"><sup class="footnote-definition-label">3</sup>
<p>In Rust, shared behavior is defined by <em>trait composition</em>, not by <em>object-oriented inheritance</em>. There's no &quot;class hierarchy&quot;, like in C++ or Java. We'll cover traits in Chapter 3.</p>
</div>
<div class="footnote-definition" id="AssocMeth"><sup class="footnote-definition-label">4</sup>
<p>Technically, per the Rust reference<sup class="footnote-reference"><a href="#RustRef">13</a></sup>, &quot;Associated functions are functions associated with a type&quot; and &quot;Associated functions whose first parameter is named <code>self</code> are called methods...&quot;. But that's pretty in the weeds. We treat <em>associated functions</em> and <em>methods</em> as distinct in this section for clarity.</p>
</div>
<div class="footnote-definition" id="SliceEff"><sup class="footnote-definition-label">5</sup>
<p>Slices references are &quot;fat pointers&quot; (tuple of pointer and element count), they allow us to pass variable-length data without copying it (recall &quot;pass-by-reference&quot;, from when we first talked about pointers).</p>
</div>
<div class="footnote-definition" id="SliceFlex"><sup class="footnote-definition-label">6</sup>
<p>Slices are flexible because different kinds of collections (say, a fixed-size array or dynamically-sized vector) can be &quot;viewed&quot; through a slice. So you'll encounter them often in idiomatic Rust code.</p>
</div>
<div class="footnote-definition" id="IDPerm"><sup class="footnote-definition-label">7</sup>
<p><a href="https://en.wikipedia.org/wiki/Permutation_group#Neutral_element_and_inverses"><em>Neutral element and inverses</em></a>. Wikipedia (Accessed 2022).</p>
</div>
<div class="footnote-definition" id="ModArith"><sup class="footnote-definition-label">8</sup>
<p><a href="https://en.wikipedia.org/wiki/Modular_arithmetic"><em>Modular arithmetic</em></a>. Wikipedia (Accessed 2022).</p>
</div>
<div class="footnote-definition" id="Cast"><sup class="footnote-definition-label">9</sup>
<p>There are best practices related to casting in Rust. Namely using traits <code>From</code> and <code>Into</code> for <em>infallible</em> conversions between types, and <code>TryFrom</code> and <code>TryInto</code> for <em>fallible</em> conversions. We'll discus this topic in detail later.</p>
</div>
<div class="footnote-definition" id="RC4Wiki"><sup class="footnote-definition-label">10</sup>
<p><a href="https://en.wikipedia.org/wiki/RC4"><em>RC4</em></a>. Wikipedia (Accessed 2022).</p>
</div>
<div class="footnote-definition" id="UnderstandingCrypto"><sup class="footnote-definition-label">11</sup>
<p><a href="https://amzn.to/3IEYuNd"><em><strong>[PERSONAL FAVORITE]</strong> Understanding Cryptography</em></a>. Christof Paar, Jan Pelzl (2009).</p>
</div>
<div class="footnote-definition" id="UnderstandingCryptoVideo"><sup class="footnote-definition-label">12</sup>
<p><a href="https://www.crypto-textbook.com/movies.php"><em>Online Cryptography Course</em></a>. Christof Paar, Jan Pelzl (2009).</p>
</div>
<div class="footnote-definition" id="RustRef"><sup class="footnote-definition-label">13</sup>
<p><a href="https://doc.rust-lang.org/reference/items/associated-items.html"><em>The Rust Reference: Associated Items</em></a>. The Rust Team (2021).</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chp2/dynamic_assurance_1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../chp2/dynamic_assurance_3.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chp2/dynamic_assurance_1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../chp2/dynamic_assurance_3.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
