<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Module System - High Assurance Rust: Developing Secure and Robust Software</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../landing.html">High Assurance Rust</a></li><li class="chapter-item expanded affix "><a href="../faq.html">Frequently Asked Questions (FAQ)</a></li><li class="chapter-item expanded affix "><a href="../engage.html">Engage with this Book!</a></li><li class="chapter-item expanded affix "><a href="../cfp.html">Sponsor Call for Proposals (CFP)</a></li><li class="chapter-item expanded affix "><a href="../download.html">Download</a></li><li class="chapter-item expanded affix "><a href="../changelog.html">Changelog</a></li><li class="chapter-item expanded affix "><a href="../license.html">License</a></li><li class="chapter-item expanded affix "><li class="part-title">Novice: Systems Security</li><li class="spacer"></li><li class="chapter-item expanded "><a href="../chp1/_index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chp1/why_this_book.html"><strong aria-hidden="true">1.1.</strong> Why this book?</a></li><li class="chapter-item expanded "><a href="../chp1/how_is_this_book_structured.html"><strong aria-hidden="true">1.2.</strong> How is this book structured?</a></li><li class="chapter-item expanded "><a href="../chp1/challenges.html"><strong aria-hidden="true">1.3.</strong> Hands-on Learning</a></li><li class="chapter-item expanded "><a href="../chp1/about_the_team.html"><strong aria-hidden="true">1.4.</strong> About the Team</a></li><li class="chapter-item expanded "><a href="../chp1/_hands_on.html"><strong aria-hidden="true">1.5.</strong> Warmup: Environment Setup</a></li></ol></li><li class="chapter-item expanded "><a href="../chp2/_index.html"><strong aria-hidden="true">2.</strong> Software Assurance</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chp2/static_vs_dynamic.html"><strong aria-hidden="true">2.1.</strong> Static vs. Dynamic Tools</a></li><li class="chapter-item expanded "><a href="../chp2/static_assurance_1.html"><strong aria-hidden="true">2.2.</strong> Static Assurance (1/2)</a></li><li class="chapter-item expanded "><a href="../chp2/static_assurance_2.html"><strong aria-hidden="true">2.3.</strong> Static Assurance (2/2)</a></li><li class="chapter-item expanded "><a href="../chp2/dynamic_assurance_1.html"><strong aria-hidden="true">2.4.</strong> Dynamic Assurance (1/3)</a></li><li class="chapter-item expanded "><a href="../chp2/dynamic_assurance_2.html"><strong aria-hidden="true">2.5.</strong> Dynamic Assurance (2/3)</a></li><li class="chapter-item expanded "><a href="../chp2/dynamic_assurance_3.html"><strong aria-hidden="true">2.6.</strong> Dynamic Assurance (3/3)</a></li><li class="chapter-item expanded "><a href="../chp2/limits.html"><strong aria-hidden="true">2.7.</strong> Limitations and Threat Modeling</a></li><li class="chapter-item expanded "><a href="../chp2/cli.html"><strong aria-hidden="true">2.8.</strong> DIY CLI Encryption Tool</a></li><li class="chapter-item expanded "><a href="../chp2/operational_assurance_1.html"><strong aria-hidden="true">2.9.</strong> Operational Assurance (1/2)</a></li><li class="chapter-item expanded "><a href="../chp2/operational_assurance_2.html"><strong aria-hidden="true">2.10.</strong> Operational Assurance (2/2)</a></li><li class="chapter-item expanded "><a href="../chp2/_hands_on.html"><strong aria-hidden="true">2.11.</strong> Challenge: Extend the CLI Tool</a></li></ol></li><li class="chapter-item expanded "><a href="../chp3/_index.html"><strong aria-hidden="true">3.</strong> Rust Zero-Crash Course</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chp3/undef.html"><strong aria-hidden="true">3.1.</strong> On Undefined Behavior</a></li><li class="chapter-item expanded "><a href="../chp3/rust_1_low_data_rep.html"><strong aria-hidden="true">3.2.</strong> Rust: Low-Level Data (1/6)</a></li><li class="chapter-item expanded "><a href="../chp3/rust_2_high_data_rep.html"><strong aria-hidden="true">3.3.</strong> Rust: High-Level Data (2/6)</a></li><li class="chapter-item expanded "><a href="../chp3/rust_3_ctrl_flow.html"><strong aria-hidden="true">3.4.</strong> Rust: Control Flow (3/6)</a></li><li class="chapter-item expanded "><a href="../chp3/rust_4_own_1.html"><strong aria-hidden="true">3.5.</strong> Rust: Ownership Principles (4/6)</a></li><li class="chapter-item expanded "><a href="../chp3/rust_5_own_2.html"><strong aria-hidden="true">3.6.</strong> Rust: Ownership in Practice (5/6)</a></li><li class="chapter-item expanded "><a href="../chp3/rust_6_error.html"><strong aria-hidden="true">3.7.</strong> Rust: Error Handling (6/6)</a></li><li class="chapter-item expanded "><a href="../chp3/modules.html" class="active"><strong aria-hidden="true">3.8.</strong> The Module System</a></li><li class="chapter-item expanded "><a href="../chp3/tooling.html"><strong aria-hidden="true">3.9.</strong> Recommended Tooling</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.10.</strong> Rust's Release Cycle</div></li><li class="chapter-item expanded "><a href="../chp3/_hands_on.html"><strong aria-hidden="true">3.11.</strong> Challenge: Port a Program</a></li></ol></li><li class="chapter-item expanded "><a href="../chp4/_index.html"><strong aria-hidden="true">4.</strong> Understanding Memory</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> A Software Perspective</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> An Attacker's Perspective</div></li><li class="chapter-item expanded "><a href="../chp4/safe_rust_PLACEHOLDER.html"><strong aria-hidden="true">4.3.</strong> Rust's Memory Safety Guarantees</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.4.</strong> Integer Representation Issues</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.5.</strong> The #![no_std] Attribute</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.6.</strong> Case Study: Real-world Rust CVEs</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.7.</strong> Debugging with Mozilla rr</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.8.</strong> Writing an Exploit</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.9.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><li class="part-title">Advanced Beginner: Core Project</li><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Binary Search Tree (BST) Basics</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Core BST Operations in Python</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.2.</strong> Problems Translating to Rust</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.3.</strong> The Importance of Balance</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.4.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.5.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Building an Arena Allocator</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Let's Talk Allocators</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> A Stack-Only Arena</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Index-based Data Structures</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.4.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.5.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> A Self-balancing BST</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chp7/traits.html"><strong aria-hidden="true">7.1.</strong> Interface-relevant Traits</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.2.</strong> Scapegoat Trees</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.3.</strong> Insert</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.4.</strong> Remove</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.5.</strong> Find</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.6.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Digital Twin Testing</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">8.1.</strong> Basic QEMU Internals</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.2.</strong> How Semi-hosting Works</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.</strong> CLI REPL Harness</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.4.</strong> Limitations</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.5.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.6.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Building Maps and Sets</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">9.1.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.2.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> Implementing Iterators</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">10.1.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.2.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><li class="part-title">Competent: Validation and Deployment</li><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> Static Verification</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">11.1.</strong> An Introduction to 1st Order Logic</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.2.</strong> Proving Absence of Panics</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.3.</strong> Deductively Verifying our Arena Allocator</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.4.</strong> Model Checking for unsafe Code</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.5.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.6.</strong> Challenge: Prove a Sorting Algorithm</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> Dynamic Testing</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">12.1.</strong> Introduction to Coverage-Guided Fuzzing</div></li><li class="chapter-item expanded "><a href="../chp12/diff_fuzz_PLACEHOLDER.html"><strong aria-hidden="true">12.2.</strong> Building a Differential Fuzzing Harness</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.3.</strong> Using Miri to Detect Undefined Behavior</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.4.</strong> Benchmarking and Optimization</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.5.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.6.</strong> Challenge: Bug-hunting with Fuzzers</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> Operational Deployment</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">13.1.</strong> Understanding unsafe (1/3)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.2.</strong> Understanding unsafe (2/3)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.3.</strong> Understanding unsafe (3/3)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.4.</strong> CFFI 101</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.5.</strong> C99 Interoperability</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.6.</strong> Python3 Interoperability</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.7.</strong> Runtime Balance Reconfiguration</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.8.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.9.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> Maximizing Assurance</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">14.1.</strong> Rust Security Research</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.2.</strong> Rust's Limitations</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.3.</strong> Best Practices Beyond Rust</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.4.</strong> TODO</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.5.</strong> Challenge: TODO</div></li></ol></li><li class="chapter-item expanded "><li class="part-title">Conclusion</li><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.</strong> Review</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">15.1.</strong> Key Concepts</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.2.</strong> Key Blue-Team Skills</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.3.</strong> Key Red-Team Skills</div></li></ol></li><li class="chapter-item expanded "><a href="../chp16_appendix/_index.html"><strong aria-hidden="true">16.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">16.1.</strong> Setup: Using our Docker Container</div></li><li class="chapter-item expanded "><a href="../chp16_appendix/tools.html"><strong aria-hidden="true">16.2.</strong> Inventory: Tools of the Trade</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/books.html"><strong aria-hidden="true">16.3.</strong> Inventory: Recommended Reading</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/resources.html"><strong aria-hidden="true">16.4.</strong> Inventory: Additional Resources</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/crypto.html"><strong aria-hidden="true">16.5.</strong> Fundamentals: Stream Ciphers</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/types.html"><strong aria-hidden="true">16.6.</strong> Fundamentals: Type Systems</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/components.html"><strong aria-hidden="true">16.7.</strong> Fundamentals: Component-Based Design</a></li><li class="chapter-item expanded "><a href="../chp16_appendix/mem_hierarch.html"><strong aria-hidden="true">16.8.</strong> Fundamentals: Memory Hierarchy</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.9.</strong> Fundamentals: Dynamic Linking</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.10.</strong> Misc: Size Optimization</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.11.</strong> Misc: The Typestate Pattern</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.12.</strong> Misc: C++ Interoperability</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.13.</strong> Misc: Compile-time Metaprogramming</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">High Assurance Rust: Developing Secure and Robust Software</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/tnballo/high-assurance-rust" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://highassurance.rs/engage.html#submit-feedback-questions-issues-or-prs" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-module-system"><a class="header" href="#the-module-system">The Module System</a></h1>
<p>In a 1994 lecture on the design of C++<sup class="footnote-reference"><a href="#CppD">1</a></sup>, Bjarne Stroustrup, the language's inventor, stated:</p>
<blockquote>
<p>I wanted a tool that provided the support for program organization that Simula<sup class="footnote-reference"><a href="#Simula">2</a></sup> provided.
The help to thinking and help to design that Simula provided.
On the other hand, I wanted something that ran really fast when it had to, like BCPL<sup class="footnote-reference"><a href="#BCPL">3</a></sup> and C.</p>
</blockquote>
<p>By &quot;program organization&quot;, Dr. Stroustrup was referring to C++'s support for object-oriented classes.
Organization support was one half of C++'s winning formula, performance being the other.
Effectively organizing code in a manner amenable to both maintenance and domain abstraction is so critical a problem that solving it for high performance applications allowed C++ to dominate for decades.</p>
<ul>
<li><strong>Rust's Alternative to Classes:</strong> in our prior discussion of high-level data, we saw how traits and structures interact to define behavior via composition - instead of inheritance. You can think of Rust structs and C++ classes as a fundamental first level of program organization.</li>
</ul>
<p>So why bring this up in section about modules<sup class="footnote-reference"><a href="#OGMods">4</a></sup>, especially when C++ didn't even get a module system until the C++20 standard (some 40 years after inception)?
Because modules are an extended solution to the timeless problem of program organization.</p>
<p>In that same 90s interview, Stroustrup offers a profoundly pragmatist insight:</p>
<blockquote>
<p>My main sort of idea about languages is that a language is someone's response to a set of problems at a given time.
That is, a language is there to solve problems rather than being an interesting item in its own right.
Our problems and our understanding of those problems naturally change over time.</p>
<p>And as long as a language is a good solution to problems that are faced by real programmers in real code, the language will live and the language will grow to meet the needs of the programmers.</p>
</blockquote>
<p>We've already established that Rust's primary value is solving the age-old memory safety problem without sacrificing predictable performance (let's lump safe concurrency under &quot;performance&quot;).
With less Undefined Behavior (UB) to debug, we can rapidly build more and more ambitious high-performance systems.</p>
<p>Almost any system worth building will eventually grow in size and complexity.
Customers request new features, development teams onboard new engineers to meet demand, and the codebase starts to expand.
Code organization is so fundamental a problem to &quot;real programmers in real code&quot; that Rust wouldn't be practical without a means to address it.</p>
<p>What tools does Rust afford us, to keep large projects organized and cohesive?
At a high level, we can break down the building blocks like so:</p>
<br>
<p align="center">
  <img width="50%" src="building_blocks.svg">
  <figure>
  <figcaption><center>Fundamental building blocks, which compose to form complex systems.</center></figcaption><br>
  </figure>
</p>
<ul>
<li>
<p><strong>Items</strong> are exportable pieces of source code: structures, functions, constants, etc. Structures, Rust's class-like abstraction, are arguably our most fundamental organization tool. The top of the program organization hierarchy.</p>
<ul>
<li>A full list of language constructs considered items is available<sup class="footnote-reference"><a href="#Items">5</a></sup>. Technically, modules are items. But for the purpose of our current code organization discussion, we'll consider them taxonomically distinct.</li>
</ul>
</li>
<li>
<p><strong>Modules</strong> group related items into cohesive units. They facilitate organizing code within a project, much like namespaces.</p>
<ul>
<li>Some programmers like to follow a &quot;one module per source file&quot; convention. But that 1:1 mapping is entirely optional. Modules are a logical, hierarchical grouping. They're not decided by the layout of a filesystem.</li>
</ul>
</li>
<li>
<p><strong>Crates</strong> group one or more related modules into either a library or a binary. They facilitate organizing code between projects. For libraries, visibility modifiers decide which items the module(s) export (e.g. the public API of the crate).</p>
<ul>
<li>Crates can also have dependencies, which are themselves crates (e.g. 3rd party libraries used internally). Chapter 2's <code>rcli</code> tool was a binary crate that had two library crate dependencies: <code>rc4</code> and <code>clap</code>.</li>
</ul>
</li>
<li>
<p><strong>System</strong> is the general term for a large piece of software made up of interconnected components. That could mean multiple Rust crates, libraries written in other programming languages that interoperate via CFFI<sup class="footnote-reference"><a href="#CFFI">6</a></sup>, or even networked sub-services that communicate using structured formats like REST<sup class="footnote-reference"><a href="#REST">7</a></sup> and gRPC<sup class="footnote-reference"><a href="#GRPC">8</a></sup>.</p>
</li>
</ul>
<h2 id="combatting-complexity-with-modules"><a class="header" href="#combatting-complexity-with-modules">Combatting Complexity with Modules</a></h2>
<p>Modules are the focus of this section.
They're a major &quot;help to design&quot; when writing code, and a &quot;help to thinking&quot; when reading it.
Modules compartmentalize functional groupings of code and define their interfaces.
They help address the timeless need for code organization, and, ultimately, help keep complexity in check.</p>
<p>As the systems we build grow in size and capability, they tend to incrementally accumulate some form of complicatedness.
Once compounded, complexity makes systems difficult to understand and modify.
Unnecessary complexity increases the chance of an outage or a security breach.</p>
<p>Accrued complexity is sometimes referred to as &quot;technical debt&quot;.
Much like financial debt, it's tough to get out of.
So designing for simplicity and maintainability should always be a priority.</p>
<p>Now the data structure library we build in this book will total less than 5,000 lines of code.
That's a tiny codebase in the grand scheme of things.
But we'll make use of Rust's module system from the outset - there are size-agnostic benefits to reap.
So let's get a feel for how modules work.</p>
<h2 id="source-code-organization"><a class="header" href="#source-code-organization">Source Code Organization</a></h2>
<p>Some languages infer modules from the layout of the filesystem.
That's not true for Rust.</p>
<p>Rust modules have a loose relationship to individual source code files (whose names end in <code>.rs</code>).
Because modules are logical groupings, we can choose from one of three module-file mappings: many-to-one, many-to-many, and one-to-one.
These aren't exclusive: a single project can mix-and-match strategies as appropriate.</p>
<p>Regardless of mapping choice(s), modules always form a tree-like hierarchy.
The module tree must have a root, typically:</p>
<ul>
<li><code>main.rs</code> for binary crates (like <code>rcli</code>)</li>
<li><code>lib.rs</code> for library crates (like <code>rc4</code>)</li>
</ul>
<p>Crates which build other targets (like tests, benchmarks, or examples) have other target-specific roots.</p>
<p>In the binary case, the hierarchy decides which items are visible in which module.
That's also true for the library case.
Additionally, library crates can choose to <em>export</em> certain items and/or modules - creating a public API.</p>
<p>Let's explore three module-file mappings that maintain the same singular hierarchy.</p>
<h3 id="1-multiple-modules---one-source-file-m1"><a class="header" href="#1-multiple-modules---one-source-file-m1">1. Multiple Modules -&gt; One Source File (<code>m:1</code>)</a></h3>
<p>A single file can contain nested modules. The syntax for an <em>inline</em> module definition is:</p>
<pre><code class="language-rust ignore">mod my_module {
    // Module contents here, potentially including nested &quot;submodules&quot;
}
</code></pre>
<p>Let's continue this chapter's running OS example, but sidestep the details of what it would take to actually create a bootable kernel (a topic well-covered in Philipp Oppermann's excellent tutorial series<sup class="footnote-reference"><a href="#BlogOS">9</a></sup>).</p>
<p>We might create a new binary crate and add the following to <code>main.rs</code>.</p>
<pre><code class="language-rust ignore">mod kern {
    pub mod sched {
        // Scheduling code here, including our `Proc` struct...

        /// Set the priority of a process
        pub fn set_priority(pid: usize, priority: usize) -&gt; bool {
            // Implementation here...
        }
    }

    pub mod dma {
        // Code related to Direct Memory Access (DMA) here...
    }

    pub mod syscall {
        // Code related to system calls here...
    }
}

// Dummy function to show testing via submodule
fn private_helper() -&gt; bool {
    true
}

#[cfg(test)]
mod tests {
    // Import public function from &quot;peer&quot; module
    use super::kern::sched::set_priority;

    // Import private function from &quot;parent&quot; module
    use super::private_helper;

    #[test]
    fn test_private_helper() {
        assert!(private_helper());
    }

    #[test]
    fn test_set_priority() {
        // Unit test here...
    }

    // More individual tests here...
}
</code></pre>
<p>With any design decision, &quot;can&quot; and &quot;should&quot; are two different things.
You likely won't want to organize an OS, or any large project, within a single file like this.</p>
<p>But a many-to-one mapping shows that modules are a flexible concept.
One aspect of this flexibility you <em>are</em> likely to leverage is a <code>tests</code> module, like the one at the bottom of the above.
It allows you to keep unit tests close to the code they're responsible for testing (within the same file).</p>
<p>This can be especially useful for testing private functions - notice how the <code>tests</code> module can use the <code>private_helper</code> function even though the function is not marked <code>pub</code>.
To understand why, we need to understand the module hierarchy this single file creates.</p>
<p>Implicitly, the file <code>main.rs</code> is itself a module.
In fact, it's the hierarchy's root.
That makes <code>mod tests</code> a <em>submodule</em> in a hierarchy, meaning &quot;child&quot; of the top-level <code>main.rs</code> module.
It sits at the same level as it's &quot;peer&quot; module (<code>kern</code>, declared in the same file):</p>
</br>
<p align="center">
  <img width="100%" src="mod_single_file.svg">
  <figure>
  <figcaption><center>The module hierarchy of the above snippet. It will remain unchanged for the next two subsections.</center></figcaption><br>
  </figure>
</p>
<p>In Rust, submodules have access to both the private and public items of their parents.</p>
<ul>
<li><strong>Example:</strong> <code>tests</code> can import the private function <code>private_helper</code> from its parent, with <code>use super::private_helper;</code>.</li>
</ul>
<p>Private items can't be accessed for peers (same level in the hierarchy, like <code>kern</code>) or children (although <code>tests</code> doesn't have child submodules in our example).</p>
<ul>
<li><strong>Example:</strong> <code>tests</code> can only access exported, public items from <code>kern</code>. It imports the public <code>set_priority</code> function via <code>use super::kern::sched::set_priority;</code>.</li>
</ul>
<h3 id="2-multiple-modules---multiple-source-files-mn"><a class="header" href="#2-multiple-modules---multiple-source-files-mn">2. Multiple Modules -&gt; Multiple Source Files (<code>m:n</code>)</a></h3>
<p>We could move the contents of <code>mod kern</code> to a file named <code>kern.rs</code>, like so:</p>
<pre><code class="language-rust ignore">pub mod sched {
    // Scheduling code here, including our `Proc` struct...

    /// Set the priority of a process
    pub fn set_priority(pid: usize, priority: usize) -&gt; bool {
        // Implementation here...
    }
}

pub mod dma {
    // Code related to Direct Memory Access (DMA) here...
}

pub mod syscall {
    // Code related to system calls here...
}
</code></pre>
<p>Notice how we no longer need an inclosing <code>pub mod kern { ... }</code>, it's implied by the filename.
After making the change, we have the following directory contents:</p>
<pre><code class="language-ignore">.
├── Cargo.toml
└── src
    ├── kern.rs
    └── main.rs

1 directory, 3 files
</code></pre>
<p>As we saw, <code>kern.rs</code> uses the unchanged, inline definitions for it's submodules (e.g. <code>pub mod sched { ... }</code>, etc).
Thus we maintain the hierarchy pictured above.</p>
<p>For <code>main.rs</code> to import the <code>set_priority</code> function, it would need to use:</p>
<pre><code class="language-rust ignore">mod kern;
use kern::sched::set_priority;
</code></pre>
<ul>
<li>
<p><code>mod kern;</code> signals that the <code>kern</code> module's contents exist in another file, either <code>kern.rs</code> or <code>kern/mod.rs</code>.</p>
<ul>
<li>These &quot;forward declarations&quot; are typically placed in a module root - whether that's the root of the entire hierarchy (as is the case here, for <code>main.rs</code>) or just a module that contains submodules.</li>
</ul>
</li>
<li>
<p><code>use kern::sched::set_priority;</code> imports a specific function from the public <code>sched</code> submodule, just like the <code>tests</code> submodule did in the previous layout.</p>
</li>
</ul>
<h3 id="3-one-module---one-source-file-11"><a class="header" href="#3-one-module---one-source-file-11">3. One Module -&gt; One Source File (<code>1:1</code>)</a></h3>
<p>In a more realistic project layout, we might opt to place every module in a separate file.
While still maintaining that same hierarchy.</p>
<p>Instead of the inline module definitions for <code>sched</code>, <code>dma</code>, and <code>syscall</code>, we could place each submodule in a dedicated file like so:</p>
<pre><code class="language-ignore">.
├── kern
│   ├── dma.rs
│   ├── sched.rs
│   └── syscall.rs
├── kern.rs
└── main.rs

1 directory, 5 files
</code></pre>
<p>When we import a module from another file, Rust looks for either <code>module_name.rs</code> or <code>module_name/mod.rs</code>.
So the following layout is equivalent to the above, it's only a matter of preference:</p>
<pre><code class="language-ignore">.
├── kern
│   ├── dma.rs
│   ├── mod.rs
│   ├── sched.rs
│   └── syscall.rs
└── main.rs

1 directory, 5 files
</code></pre>
<p>In either case, we'd again drop the enclosing, inline <code>pub mod mod_name { ... }</code> for three submodules because it's implied by the filename. E.g. <code>sched.rs</code> now contains:</p>
<pre><code class="language-rust  ignore">// Scheduling code here, including our `Proc` struct...

/// Set the priority of a process
pub fn set_priority(pid: usize, priority: usize) -&gt; bool {
    // Implementation here...
}
</code></pre>
<p><code>kern.rs</code> or <code>kern/mod.rs</code> (depending on which layout we choose) is a module root that sits under the whole-hierarchy root <code>main.rs</code> (as pictured above).
In our 1:1 layout, this file gets to control how its child submodules are exposed to <code>main.rs</code>, its parent.</p>
<p>For simplicity, let's assume we went with the first choice, a <code>kern.rs</code>.
This file could choose to expose the entire <code>sched</code> submodule (e.g. <em>re-export</em> it) with:</p>
<pre><code class="language-rust ignore">pub mod sched;
</code></pre>
<p>Then <code>main.rs</code> would import the <code>set_priority</code> function as before (in the prior <code>m:n</code> case):</p>
<pre><code class="language-rust ignore">mod kern;
use kern::sched::set_priority;
</code></pre>
<p>But we also have the option to abstract away details of <code>kern</code>'s internals from users of the module.</p>
<p>Maybe <code>main.rs</code> should still be able to use the <code>set_priority</code> function, but shouldn't be aware that, internally, the function is part of some larger <code>sched</code> module.
If <code>kern.rs</code> re-exported only a single function and not the entire module:</p>
<pre><code class="language-rust ignore">mod sched;
pub use sched::set_priority;
</code></pre>
<p>Then <code>main.rs</code> would be able to use <code>set_priority</code> with:</p>
<pre><code class="language-rust ignore">mod kern;
use kern::set_priority;
</code></pre>
<p>This may seem like a minor difference, we went from importing the same function via <code>kern::sched::set_priority</code> to <code>kern::set_priority</code>.
The function and the module hierarchy remained unchanged, we only shortened an item's <em>path</em>.</p>
<p>But <em>controlling visibility</em> is a critical tool for managing complexity in a codebase.
It gives us the freedom to organize a large system internally in one way, but expose only a subset of that system to an end user - in a manner that doesn't leak details of the internal organization.</p>
<p>Keep in mind that a public API (which includes modules, functions, data types, and constants - among other items) often makes stability guarantees.
Systems that expose internal details via public APIs become hard to refactor without &quot;breaking changes&quot; (those that cause downstream code to stop compiling).</p>
<p>In addition to creating maintenance burden, large and detailed API surfaces increase complexity and cognitive load (for both API developers and API users).</p>
<p>Thus, a major goal of modular design is providing abstraction by controlling visibility of internal interfaces.
Let's dig into what options Rust affords us, beyond limiting re-exports at a module root.</p>
<h2 id="controlling-visibility"><a class="header" href="#controlling-visibility">Controlling Visibility</a></h2>
<p>Rust's visibility modifiers help keep internal and external API surface in check.
The goal is to group items into one of two categories:</p>
<ul>
<li><strong>Private</strong> - those accessible only within the same module or its submodules.</li>
<li><strong>Public</strong> - those exported by a module.</li>
</ul>
<p>In addition to reigning in complexity, reducing visibility allows us to maintain <em>invariants</em>.
For example, say a structure provides getter and setter functions for a private field.
Instead of making the field public.
If the setter function handles invalid parameters (perhaps by returning an error) we can ensure the structure never enters a bad state (like having a field whose value is illegal or out-of-range).
In object-oriented languages, similar practices fall under the umbrella of <em>encapsulation</em>.</p>
<p>By default, items are private in Rust (visible only within the current module).
Increasing visibility requires explicit opt-in.
There are five modifiers<sup class="footnote-reference"><a href="#VisMod">10</a></sup> for public visibility than can be applied to any item (module, function, structure, structure field, etc<sup class="footnote-reference"><a href="#Items">5</a></sup>).
Listed from least-to-most restrictive:</p>
<table><thead><tr><th>Modifier</th><th>Where is the item visible?</th></tr></thead><tbody>
<tr><td><code>pub</code></td><td>Everywhere, outside or inside the current module.</td></tr>
<tr><td><code>pub(crate)</code></td><td>Anywhere within the current crate.</td></tr>
<tr><td><code>pub(super)</code></td><td>Only within the parent module and submodules.</td></tr>
<tr><td><code>pub(in some::path::here)</code></td><td>Only within submodules along the provided path.</td></tr>
<tr><td><code>pub(self)</code></td><td>Only in the current module (like not using <code>pub</code> at all).</td></tr>
</tbody></table>
<p>In lieu of an example in this section, we'll use some of the above modifiers as we implement the core project.</p>
<p>Keep in mind that just because an item is <em>visible</em> doesn't mean it's <em>available</em>.
Items still need to be exported by the module that contains them, and then imported by its end-user.
Without that export and the corresponding import, an item will not be <em>in scope</em>.</p>
<h2 id="takeaway"><a class="header" href="#takeaway">Takeaway</a></h2>
<p>Code organization is a critical and timeless problem.
Rust's module system offers a granular and configurable solution for large projects.
Effective use of the module system is key to keeping complexity in check.</p>
<p>Rust modules are a logical, hierarchical grouping.
Although they're not inferred from the filesystem directly, there are several ways to map modules to source files.</p>
<p>Internally, visibility modifiers control which item is visible in which module.
Externally, a module can choose to re-export certain items for public consumption.
In both cases, visibility controls API surface and aids upholding invariants.</p>
<p>We've gotten a taste for how modules keep projects organized.
Let's move onto tools for keeping those same projects healthy over time.</p>
<blockquote>
<p><strong>What about organizing software systems, beyond Rust modules?</strong></p>
<p>The <a href="../chp16_appendix/components.html"><em>Fundamentals: Component-Based Design</em></a> section of the appendix is an expanded, generally applicable continuation of our &quot;program organization&quot; discussion.</p>
<p>Whereas this section focused on Rust's module system, the supplementary appendix section explores universal principles.</p>
</blockquote>
<hr />
<div class="footnote-definition" id="CppD"><sup class="footnote-definition-label">1</sup>
<p><a href="https://www.youtube.com/watch?v=69edOm889V4"><em>The Design of C++</em></a>. Bjarne Stroustrup (1994).</p>
</div>
<div class="footnote-definition" id="Simula"><sup class="footnote-definition-label">2</sup>
<p>A 1962 object-oriented language designed for writing simulations. Introduced the idea of classes.</p>
</div>
<div class="footnote-definition" id="BCPL"><sup class="footnote-definition-label">3</sup>
<p>A 1967 predecessor to C originally intended for compiler development. Performant but type-less.</p>
</div>
<div class="footnote-definition" id="OGMods"><sup class="footnote-definition-label">4</sup>
<p><a href="https://www.win.tue.nl/%7Ewstomv/edu/2ip30/references/criteria_for_modularization.pdf"><em>On the Criteria To Be Used in Decomposing Systems into Modules</em></a>. David L. Parnas (1972).</p>
</div>
<div class="footnote-definition" id="Items"><sup class="footnote-definition-label">5</sup>
<p><a href="https://doc.rust-lang.org/reference/items.html"><em>Items</em></a>. The Rust Reference (Accessed 2022).</p>
</div>
<div class="footnote-definition" id="CFFI"><sup class="footnote-definition-label">6</sup>
<p><a href="https://en.wikipedia.org/wiki/Foreign_function_interface">Foreign function interface</a>. Wikipedia (Accessed 2022).</p>
</div>
<div class="footnote-definition" id="REST"><sup class="footnote-definition-label">7</sup>
<p><a href="https://www.redhat.com/en/topics/api/what-is-a-rest-api">What is a REST API?</a>. RedHat (2020).</p>
</div>
<div class="footnote-definition" id="GRPC"><sup class="footnote-definition-label">8</sup>
<p><a href="https://grpc.io/docs/what-is-grpc/core-concepts/">Core concepts, architecture and lifecycle</a>. Google (Accessed 2022).</p>
</div>
<div class="footnote-definition" id="BlogOS"><sup class="footnote-definition-label">9</sup>
<p><a href="https://os.phil-opp.com/"><em>Writing an OS in Rust</em></a>. Philipp Oppermann (Accessed 2022).</p>
</div>
<div class="footnote-definition" id="VisMod"><sup class="footnote-definition-label">10</sup>
<p><a href="https://doc.rust-lang.org/reference/visibility-and-privacy.html"><em>Visibility and Privacy</em></a>. The Rust Reference (Accessed 2022).</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chp3/rust_6_error.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../chp3/tooling.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chp3/rust_6_error.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../chp3/tooling.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
